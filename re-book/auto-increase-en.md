# TenDB Cluster Auto-increment Columns

TenDB Cluster only guarantee the uniqueness of auto-increment ID, <font color="#dd0000">continuity  and increment are not guaranteed</font>.  
A table in the TenDB Cluster will be scattered by TSpider and distributed evenly in several TenDB nodes; And there are several TSpider nodes  retrive and update data from the table. So it is necessary to maintain the  auto-increment column on each TSpider node which is different from single-instance MySQL.  
If user want to enable the same feature of self-increment as  single-instance MySQL, then each TSpider node needs to lock all tables (all tables in TenDB node) when update auto-increment columns or use third-party resources as critical resources to maintain auto-increment ID. But the above two solutions will cause  performance loss,  which is not suitable for the engineering environment.  
The strategy of TenDB Cluster auto-increment is, each TSpider node maintain its own auto-increment column, and ensure that the self-increment value generated by a TSpider node must be different from the other TSpider nodes.      
Because of the strategy, the auto-increment ID is increment only on the same TSpider node, not on the whole cluster, but the cost of maintaining the auto-increment column is the lowest.    
In a word, TSpider will generate a global non-continuous unique identity for auto-increment.


<font color="#dd0000">It is recommended to enable TenDB Cluster auto-increment, and use bigint for auto-increment column</font> 



## Usage

TSpider maintain auto-increment column by three parameters:


** `spider_auto_increment_mode_switch` **  
Whether the auto-increment is enabled. The value can be 0 (or OFF) to disable or 1 (or ON) to enable. If on, TSpider will generate a global non-continuous unique identity for new rows. Identity only ensure incremental on the same TSpider node.   

** `spider_auto_increment_mode_value ` **  
TSpider node generate global non-continuous unique identity's start number. All TSpider's value must be different. Valid value can be computed by TSpider's increment value modulo spider_auto_increment_step. 

** `spider_auto_increment_step` **     
The step of the global non-continuous unique identity generated by TSpider node.  All TSpider nodes must be the same.     

<font color="#dd0000">It is necessary to make sure  that spider_auto_increment_step is the same  and spider_auto_increment_mode_value is different in each TSpider node</font> 
，If the parameters of  a TSpider node are as follows: 

```
spider_auto_increment_mode_switch=1
spider_auto_increment_mode_value=3
spider_auto_increment_step=17
```
then the spider_auto_increment_mode_value will be 3 20 37 54 ...


The following will briefly explain the implementation principle.
## Principle
TSpider is also a MySQL node, each table with auto-increment column has it's own last_insert_id. If each TSpider node only use the last_insert_id maintained by itself, performance must be very good.   
But in the TenDB Cluster, there are several TSpider nodes retrive and update data from TenDB node. If each TSpider node maintains it's own auto-increment column as the traditional MySQL, will cause duplicate key conflicts. However, in most scenes: the self-increment column value has no practical significance, and it is mostly used as a unique identifier, and there is no requirement for the generation order.  
So , each TSpider node maintain id%m=n, and the n is global unique. Such as, TSpider node1 maintain the value list: `1，1+17，1+17+17` , and TSpider node2 maintain the value list: `2，2+17，2+17+17…`, and so on. TSpider get max(id) from TenDB node and generate local id  only when it is necessary , such as TSpider node restart.  


<img src="../pic/auto-increment.png" width = "500" height = "300" alt="图片名称" align=center />

## Note
 1. If a table with  auto-increment column, the column must be  `bigint`,  and the  auto-increment id is a global non-continuous unique identity. 
 2. It is necessary to make sure  that spider_auto_increment_step is the same  and spider_auto_increment_mode_value is different in each TSpider node